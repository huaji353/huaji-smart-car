C251 COMPILER V5.60.0,  zf_device_ble6a20                                                  11/06/25  16:16:32  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE zf_device_ble6a20
OBJECT MODULE PLACED IN .\out_file\zf_device_ble6a20.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE ..\..\libraries\zf_device\zf_device_ble6a20.c LARGE NOALIAS WARNINGLEV
                    -EL(3) OPTIMIZE(1,SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;.
                    -.\..\libraries\zf_driver;..\user;..\code) DEBUG PRINT(.\out_file\zf_device_ble6a20.lst) TABS(2) OBJECT(.\out_file\zf_dev
                    -ice_ble6a20.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2          * AI8051U Opensourec Library å³ï¼ˆAI8051U å¼€æºåº“ï¼‰æ˜¯ä¸€ä¸ªåŸºäºå®˜æ–¹ SDK æ¥å£çš„ç¬¬ä¸‰æ–¹å¼€æº
             -åº“
    3          * Copyright (c) 2022 SEEKFREE é€é£ç§‘æŠ€
    4          *
    5          * æœ¬æ–‡ä»¶æ˜¯STC å¼€æºåº“çš„ä¸€éƒ¨åˆ†
    6          *
    7          * AI8051U å¼€æºåº“ æ˜¯å…è´¹è½¯ä»¶
    8          * æ‚¨å¯ä»¥æ ¹æ®è‡ªç”±è½¯ä»¶åŸºé‡‘ä¼šå‘å¸ƒçš„ GPLï¼ˆGNU General Public Licenseï¼Œå³ GNUé€šç”¨å…¬å…±è®¸
             -å¯è¯ï¼‰çš„æ¡æ¬¾
    9          * å³ GPL çš„ç¬¬3ç‰ˆï¼ˆå³ GPL3.0ï¼‰æˆ–ï¼ˆæ‚¨é€‰æ‹©çš„ï¼‰ä»»ä½•åæ¥çš„ç‰ˆæœ¬ï¼Œé‡æ–°å‘å¸ƒå’Œ/æˆ–ä¿®æ”
             -¹å®ƒ
   10          *
   11          * æœ¬å¼€æºåº“çš„å‘å¸ƒæ˜¯å¸Œæœ›å®ƒèƒ½å‘æŒ¥ä½œç”¨ï¼Œä½†å¹¶æœªå¯¹å…¶ä½œä»»ä½•çš„ä¿è¯
   12          * ç”šè‡³æ²¡æœ‰éšå«çš„é€‚é”€æ€§æˆ–é€‚åˆç‰¹å®šç”¨é€”çš„ä¿è¯
   13          * æ›´å¤šç»†èŠ‚è¯·å‚è§ GPL
   14          *
   15          * æ‚¨åº”è¯¥åœ¨æ”¶åˆ°æœ¬å¼€æºåº“çš„åŒæ—¶æ”¶åˆ°ä¸€ä»½ GPL çš„å‰¯æœ¬
   16          * å¦‚æœæ²¡æœ‰ï¼Œè¯·å‚é˜…<https://www.gnu.org/licenses/>
   17          *
   18          * é¢å¤–æ³¨æ˜ï¼š
   19          * æœ¬å¼€æºåº“ä½¿ç”¨ GPL3.0 å¼€æºè®¸å¯è¯åè®® ä»¥ä¸Šè®¸å¯ç”³æ˜ä¸ºè¯‘æ–‡ç‰ˆæœ¬
   20          * è®¸å¯ç”³æ˜è‹±æ–‡ç‰ˆåœ¨ libraries/doc æ–‡ä»¶å¤¹ä¸‹çš„ GPL3_permission_statement.txt æ–‡ä»¶ä¸­
   21          * è®¸å¯è¯å‰¯æœ¬åœ¨ libraries æ–‡ä»¶å¤¹ä¸‹ å³è¯¥æ–‡ä»¶å¤¹ä¸‹çš„ LICENSE æ–‡ä»¶
   22          * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åº ä½†ä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ï¼ˆå³æœ¬
             -å£°æ˜ï¼‰
   23          *
   24          * æ–‡ä»¶åç§°          
   25          * å…¬å¸åç§°          æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   26          * ç‰ˆæœ¬ä¿¡æ¯          æŸ¥çœ‹ libraries/doc æ–‡ä»¶å¤¹å†… version æ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   27          * å¼€å‘ç¯å¢ƒ          MDK FOR C251
   28          * é€‚ç”¨å¹³å°          AI8051U
   29          * åº—é“ºé“¾æ¥          https://seekfree.taobao.com/
   30          *
   31          * ä¿®æ”¹è®°å½•
   32          * æ—¥æœŸ              ä½œè€…           å¤‡æ³¨
   33          * 2024-08-01        å¤§W            first version
   34          *********************************************************************************************************
             -***********/
   35          /********************************************************************************************************
             -*************
   36          * æ¥çº¿å®šä¹‰ï¼š
   37          *                   ------------------------------------
   38          *                   æ¨¡å—ç®¡è„š            å•ç‰‡æœºç®¡è„š
   39          *                   RX                  æŸ¥çœ‹ zf_device_wireless_ble6a20.h ä¸­ BLE6A20_RX_PIN  å®å®šä¹‰
   40          *                   TX                  æŸ¥çœ‹ zf_device_wireless_ble6a20.h ä¸­ BLE6A20_TX_PIN  å®å®šä¹‰
   41          *                   RTS                 æŸ¥çœ‹ zf_device_wireless_ble6a20.h ä¸­ BLE6A20_RTS_PIN å®å®šä¹‰
   42          *                   VCC                 3.3Vç”µæº
   43          *                   GND                 ç”µæºåœ°
   44          *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   45          *                   ------------------------------------
   46          *********************************************************************************************************
             -************/
   47          
   48          #include "zf_device_ble6a20.h"
C251 COMPILER V5.60.0,  zf_device_ble6a20                                                  11/06/25  16:16:32  PAGE 2   

   49          #include "zf_common_clock.h"
   50          #include "zf_common_debug.h"
   51          #include "zf_common_fifo.h"
   52          #include "zf_driver_delay.h"
   53          #include "zf_driver_gpio.h"
   54          #include "zf_driver_uart.h"
   55          #include "zf_device_type.h"
   56          
   57          #pragma warning disable = 183
   58          #pragma warning disable = 177
   59          
   60          static  fifo_struct                                     ble6a20_fifo;
   61          static  uint8                                           ble6a20_buffer[BLE6A20_BUFFER_SIZE];
   62          
   63          
   64          
   65          
   66          //-------------------------------------------------------------------------------------------------------
             -------------
   67          // å‡½æ•°ç®€ä»‹     è“ç‰™è½¬ä¸²å£æ¨¡å— å‘é€æ•°æ®
   68          // å‚æ•°è¯´æ˜     data            8bit æ•°æ®
   69          // è¿”å›å‚æ•°     uint32          å‰©ä½™å‘é€é•¿åº¦ 0-å‘é€å®Œæ¯• 1-æœªå‘é€å®Œæˆ
   70          // ä½¿ç”¨ç¤ºä¾‹     ble6a20_send_byte(data);
   71          // å¤‡æ³¨ä¿¡æ¯
   72          //-------------------------------------------------------------------------------------------------------
             -------------
   73          uint32 ble6a20_send_byte (const uint8 dat)
   74          {
   75   1          uint16 time_count = BLE6A20_TIMEOUT_COUNT;
   76   1          
   77   1          while(time_count)
   78   1          {
   79   2              if(!gpio_get_level(BLE6A20_RTS_PIN))
   80   2              {
   81   3                  uart_write_byte(BLE6A20_INDEX, dat);                         // å‘é€æ•°æ®
   82   3                  break;
   83   3              }
   84   2              
   85   2              time_count --;
   86   2              system_delay_ms(1);
   87   2          }
   88   1          
   89   1          return (0 == time_count);
   90   1      }
   91          
   92          //-------------------------------------------------------------------------------------------------------
             -------------
   93          // å‡½æ•°ç®€ä»‹     è“ç‰™è½¬ä¸²å£æ¨¡å— å‘é€æ•°æ®å—
   94          // å‚æ•°è¯´æ˜     *buff           å‘é€ç¼“å†²åŒº
   95          // å‚æ•°è¯´æ˜     len             å‘é€æ•°æ®é•¿åº¦
   96          // è¿”å›å‚æ•°     uint32          å‰©ä½™å‘é€é•¿åº¦
   97          // ä½¿ç”¨ç¤ºä¾‹     ble6a20_send_buffer(buff, 64);
   98          // å¤‡æ³¨ä¿¡æ¯
   99          //-------------------------------------------------------------------------------------------------------
             -------------
  100          uint32 ble6a20_send_buffer (const uint8 *buff, uint32 len)
  101          {
  102   1          uint16 time_count = 0;
  103   1          //zf_assert(NULL != buff);
  104   1          
  105   1          while(0 != len)
  106   1          {
  107   2              if(!gpio_get_level(BLE6A20_RTS_PIN))                              // å¦‚æœRTSä¸ºä½ç”µå¹³ åˆ™ç»§
             -ç»­å‘é€æ•°æ®
  108   2              {
  109   3                  if(30 <= len)                                                       // æ•°æ®åˆ† 30byte æ¯åŒ
C251 COMPILER V5.60.0,  zf_device_ble6a20                                                  11/06/25  16:16:32  PAGE 3   

             -…å‘é€
  110   3                  {
  111   4                      uart_write_buffer(BLE6A20_INDEX, buff, 30);               // å‘é€æ•°æ®
  112   4                      buff += 30;                                                     // åœ°å€åç§»
  113   4                      len -= 30;                                                      // æ•°é‡
  114   4                      time_count = 0;
  115   4                  }
  116   3                  else                                                                // ä¸è¶³ 30byte çš„æ•°æ
             -®ä¸€æ¬¡æ€§å‘é€å®Œæ¯•
  117   3                  {
  118   4                      uart_write_buffer(BLE6A20_INDEX, buff, (uint16)len);              // å‘é€æ•°æ®
  119   4                      len = 0;
  120   4                      break;
  121   4                  }
  122   3              }
  123   2              else                                                                    // å¦‚æœRTSä¸ºé«˜ç”µå¹³ 
             -åˆ™æ¨¡å—å¿™
  124   2              {
  125   3                  if(BLE6A20_TIMEOUT_COUNT <= (++ time_count))                  // è¶…å‡ºäº†æœ€å¤§ç­‰å¾…æ—¶é—´
  126   3                  {
  127   4                      break;                                                          // é€€å‡ºå‘é€
  128   4                  }
  129   3                  
  130   3                  system_delay_ms(1);
  131   3              }
  132   2          }
  133   1          
  134   1          return len;
  135   1      }
  136          
  137          
  138          
  139          //-------------------------------------------------------------------------------------------------------
             -------------
  140          // å‡½æ•°ç®€ä»‹     è“ç‰™è½¬ä¸²å£æ¨¡å— è¯»å–ç¼“å†²
  141          // å‚æ•°è¯´æ˜     *buff           æ¥æ”¶ç¼“å†²åŒº
  142          // å‚æ•°è¯´æ˜     len             è¯»å–æ•°æ®é•¿åº¦
  143          // è¿”å›å‚æ•°     uint32          å®é™…è¯»å–æ•°æ®é•¿åº¦
  144          // ä½¿ç”¨ç¤ºä¾‹     ble6a20_read_buffer(buff, 32);
  145          // å¤‡æ³¨ä¿¡æ¯
  146          //-------------------------------------------------------------------------------------------------------
             -------------
  147          uint32 ble6a20_read_buffer (uint8 *buff, uint32 len)
  148          {
  149   1          uint32 data_len = len;
  150   1          //zf_assert(NULL != buff);
  151   1          fifo_read_buffer(&ble6a20_fifo, buff, &data_len, FIFO_READ_AND_CLEAN);
  152   1          return data_len;
  153   1      }
  154          
  155          //-------------------------------------------------------------------------------------------------------
             -------------
  156          // å‡½æ•°ç®€ä»‹     è“ç‰™è½¬ä¸²å£æ¨¡å— ä¸²å£ä¸­æ–­å›è°ƒå‡½æ•°
  157          // å‚æ•°è¯´æ˜     void
  158          // è¿”å›å‚æ•°     void
  159          // ä½¿ç”¨ç¤ºä¾‹     ble6a20_callback();
  160          // å¤‡æ³¨ä¿¡æ¯     è¯¥å‡½æ•°åœ¨ ISR æ–‡ä»¶ ä¸²å£ä¸­æ–­ç¨‹åºè¢«è°ƒç”¨
  161          //              ç”±ä¸²å£ä¸­æ–­æœåŠ¡å‡½æ•°è°ƒç”¨ wireless_module_uart_handler() å‡½æ•°
  162          //              å†ç”± wireless_module_uart_handler() å‡½æ•°è°ƒç”¨æœ¬å‡½æ•°
  163          //-------------------------------------------------------------------------------------------------------
             -------------
  164          void ble6a20_callback (uint8 uart_dat)
  165          {
  166   1      //    uart_query_byte(BLE6A20_INDEX, &ble6a20_data);
  167   1          fifo_write_buffer(&ble6a20_fifo, &uart_dat, 1);
  168   1      }
C251 COMPILER V5.60.0,  zf_device_ble6a20                                                  11/06/25  16:16:32  PAGE 4   

  169          
  170          //-------------------------------------------------------------------------------------------------------
             -------------
  171          // å‡½æ•°ç®€ä»‹     è“ç‰™è½¬ä¸²å£æ¨¡å— åˆå§‹åŒ–
  172          // å‚æ•°è¯´æ˜     void
  173          // è¿”å›å‚æ•°     void
  174          // ä½¿ç”¨ç¤ºä¾‹     ble6a20_init();
  175          // å¤‡æ³¨ä¿¡æ¯
  176          //-------------------------------------------------------------------------------------------------------
             -------------
  177          uint8 ble6a20_init (void)
  178          {
  179   1          uint8 return_state = 0;
  180   1          
  181   1          // ç­‰å¾…æ¨¡å—åˆå§‹åŒ–
  182   1          system_delay_ms(50);
  183   1          
  184   1          set_wireless_type(BLE6A20, BLE6A20_INDEX, ble6a20_callback);
  185   1          
  186   1          fifo_init(&ble6a20_fifo, FIFO_DATA_8BIT, ble6a20_buffer, BLE6A20_BUFFER_SIZE);
  187   1          gpio_init(BLE6A20_RTS_PIN, GPIO, GPIO_HIGH, GPIO_NO_PULL);
  188   1          
  189   1          // æœ¬å‡½æ•°ä½¿ç”¨çš„æ³¢ç‰¹ç‡ä¸º115200 ä¸ºè“ç‰™è½¬ä¸²å£æ¨¡å—çš„é»˜è®¤æ³¢ç‰¹ç‡ å¦‚éœ€å…¶ä»–æ³¢ç‰¹
             -ç‡è¯·è‡ªè¡Œé…ç½®æ¨¡å—å¹¶ä¿®æ”¹ä¸²å£çš„æ³¢ç‰¹ç‡
  190   1          uart_init (BLE6A20_INDEX, BLE6A20_BUAD_RATE, BLE6A20_RX_PIN, BLE6A20_TX_PIN);   // åˆå§‹åŒ–ä¸²å£
  191   1          uart_rx_interrupt(BLE6A20_INDEX, 1);
  192   1          
  193   1          return return_state;
  194   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       584     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =       114     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
